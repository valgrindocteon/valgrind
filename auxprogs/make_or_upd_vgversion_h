#!/bin/sh

extract_git_version()
{
    if [ -d "$1"/.git ]
    then
        git rev-parse --short=10 HEAD
    else
        echo "unknown"
    fi    
}

srcdir="${1:-.}"

if [ -e "$srcdir"/include/vgversion_dist.h ]
then
    cp "$srcdir"/include/vgversion_dist.h include/vgversion.h.tmp
else
    cat > include/vgversion.h.tmp <<EOF
/* Do not edit: file generated by auxprogs/make_or_upd_vgversion_h.
   This file defines VGGIT, used to report GIT revision
   when using command line options:  -v --version
*/
#define VGGIT "$(extract_git_version .)"
EOF
fi

if [ -f include/vgversion.h ]
then
    # There is already a vgversion.h.
    # Update it only if we found a different and real git version
    if grep -q unknown include/vgversion.h.tmp ||
       cmp -s include/vgversion.h include/vgversion.h.tmp
    then
        rm -f include/vgversion.h.tmp
    else
        mv include/vgversion.h.tmp include/vgversion.h
    fi
else
    # There is no vgversion.h. Use the one just generated, whatever it is.
    mv include/vgversion.h.tmp include/vgversion.h
fi
